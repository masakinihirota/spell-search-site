# 設計書

## 概要

所持している歌の数字と呪文に必要な歌の数字のマッチング状況を表示する機能です。

## 主要コンポーネント

### SpellMatchingCache システム

- **初期キャッシュ**: ゲーム開始時（所持歌数 0）の全呪文マッチング結果を事前計算・保存
- 所持歌変更後、0.5 秒のデバウンス後にバックグラウンド計算を開始
- 全呪文のマッチング結果を事前計算してメモリにキャッシュ
- Map<spellId, SongMatchingResult>形式でメモリにキャッシュ
- 表示時は計算済み結果を即座に取得

### SongMatchingDisplay コンポーネント

- spellId を受け取り、キャッシュから結果を取得して表示
- 所持歌数字、不足数字、マッチング率を表示
- マッチング率に応じた背景色変更

### 計算ユーティリティ

- マッチング率計算: `(所持数字の桁数 / 必要数字の桁数) × 100`
- 不足数字計算: 必要数字から所持数字を除いた残り

## 型定義

```typescript
interface SongMatchingResult {
  possessedDigits: string; // 所持している数字
  missingDigits: string; // 不足している数字
  matchingPercentage: number; // マッチング率 (0-100)
}
```

## 計算例

- 所持歌: "25"、必要歌: "258"
- マッチング率: (2 / 3) × 100 = 66%
- 不足数字: "8"

## 初期キャッシュとデバウンス機能

### 初期キャッシュ（所持歌数 0）

- アプリ起動時に所持歌数 0 の状態で全呪文のマッチング結果を事前計算
- 初回表示時の高速化を実現
- 全呪文のマッチング率は 0%、不足数字は全数字となる

### デバウンス機能

- 所持歌変更後、0.5 秒間の待機時間を設ける
- 待機中に追加の変更があった場合、タイマーをリセット
- 最後の変更から 0.5 秒経過後にバックグラウンド計算を開始
- 計算中は「更新中」状態を表示（オプション）

## UI/UX 設計

### 表示レイアウト

```
[呪文名]                    [25] [8] [66%]
```

### 色彩設計

#### ライトモード

- 0%: 現在の背景色（白色 bg-white）
- 1-49%: 薄い赤 (#fef2f2)
- 50-74%: 薄い黄 (#fefce8)
- 75-99%: 薄い緑 (#f0fdf4)
- 100%: 濃い緑 (#dcfce7) + 太い枠線

#### ダークモード

- 0%: 現在の背景色（ダークモード対応色）
- 1-49%: 暗い赤 (#450a0a)
- 50-74%: 暗い黄 (#451a03)
- 75-99%: 暗い緑 (#14532d)
- 100%: 濃い緑 (#166534) + 太い枠線

### レンダリング最適化

1. **React.memo**: 不要な再レンダリングを防止
2. **useMemo**: 重い計算のメモ化
3. **useCallback**: 関数の再生成を防止

## 技術スタック

### フロントエンド

- **React 19**: UI ライブラリ
- **Next.js 15**: フレームワーク
- **TypeScript**: 型安全性
- **Tailwind CSS**: スタイリング
- **Biome**: リンター・フォーマッター

### 状態管理

- **React Hooks**: ローカル状態管理
- **Context API**: グローバル状態（必要に応じて）

## 設計判断の根拠

### 計算ロジックの選択

**桁数ベースの計算を選択した理由**:

- ユーザーの直感的理解に合致
- 実装が簡潔で保守しやすい
- パフォーマンスが良好

### UI 配置の選択

**右上配置を選択した理由**:

- 既存の UI レイアウトとの整合性
- 視線の自然な流れに沿っている
- 情報の階層が明確

### 色彩設計の選択

**段階的な色変化を選択した理由**:

- 進捗状況の直感的な理解
- ブランドカラーとの調和
